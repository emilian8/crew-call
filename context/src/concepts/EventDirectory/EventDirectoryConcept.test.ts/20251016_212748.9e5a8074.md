---
timestamp: 'Thu Oct 16 2025 21:27:48 GMT-0400 (Eastern Daylight Time)'
content_id: 9e5a80745e715a0120a98480e988751019fa12f20521f61044aa9520d05c4fde
---

# file: src/concepts/EventDirectory/EventDirectoryConcept.test.ts

```typescript
import { assertEquals, assertExists, assertNotEquals } from "jsr:@std/assert";
import { testDb } from "@utils/database.ts";
import { ID } from "@utils/types.ts";
import EventDirectoryConcept from "./EventDirectoryConcept.ts";

const alice = "user:Alice" as ID;
const bob   = "user:Bob" as ID;
const cara  = "user:Cara" as ID;

Deno.test("Principle: Organizer creates event, invites members, manages active flag", async () => {
  const [db, client] = await testDb();
  const ed = new EventDirectoryConcept(db);

  try {
    // 1) Organizer creates an event
    const startsAt = new Date("2025-10-20T10:00:00Z");
    const endsAt   = new Date("2025-10-21T10:00:00Z");
    const createRes = await ed.createEvent({
      creator: alice,
      title: "Week of Oct 20 — House Chores",
      startsAt,
      endsAt,
    });
    assertNotEquals("error" in createRes, true, "createEvent should succeed");
    const { event } = createRes as { event: ID };
    assertExists(event, "Returned event id should exist");

    // Creator should be organizer
    const members1 = await ed._getEventMembers({ event });
    assertEquals(members1.length, 1, "Exactly one member initially (the creator)");
    assertEquals(members1[0].user, alice);
    assertEquals(members1[0].role, "Organizer");

    // 2) Organizer invites a duty member
    const invite1 = await ed.invite({ event, inviter: alice, invitee: bob, role: "DutyMember" });
    assertEquals("error" in invite1, false, "invite should succeed");

    const members2 = await ed._getEventMembers({ event });
    assertEquals(members2.length, 2, "Now two members");
    const bobRow = members2.find(m => m.user === bob);
    assertExists(bobRow, "Bob should be in membership");
    assertEquals(bobRow!.role, "DutyMember");

    // 3) Organizer toggles active flag off then on
    const offRes = await ed.setActive({ event, setter: alice, flag: false });
    assertEquals("error" in offRes, false, "setActive(false) should succeed");
    const evtAfterOff = await ed._getEvent({ event });
    assertEquals(evtAfterOff?.active, false, "Event should now be inactive");

    const onRes = await ed.setActive({ event, setter: alice, flag: true });
    assertEquals("error" in onRes, false, "setActive(true) should succeed");
    const evtAfterOn = await ed._getEvent({ event });
    assertEquals(evtAfterOn?.active, true, "Event should now be active again");

  } finally {
    await client.close();
  }
});

Deno.test("Action: createEvent enforces startsAt < endsAt and Date types", async () => {
  const [db, client] = await testDb();
  const ed = new EventDirectoryConcept(db);

  try {
    // startsAt >= endsAt
    const bad1 = await ed.createEvent({
      creator: alice,
      title: "Invalid",
      startsAt: new Date("2025-10-22T12:00:00Z"),
      endsAt:   new Date("2025-10-22T12:00:00Z"),
    });
    assertEquals("error" in bad1, true, "equal times should fail");

    const bad2 = await ed.createEvent({
      creator: alice,
      title: "Invalid 2",
      startsAt: new Date("2025-10-23T13:00:00Z"),
      endsAt:   new Date("2025-10-23T12:59:59Z"),
    });
    assertEquals("error" in bad2, true, "startsAt after endsAt should fail");

    // Type check (simulate wrong type by casting)
    // @ts-ignore intentional misuse for runtime guard
    const bad3 = await ed.createEvent({ creator: alice, title: "Wrong types", startsAt: "not a date", endsAt: new Date() });
    assertEquals("error" in bad3, true, "non-Date startsAt should fail");

  } finally {
    await client.close();
  }
});

Deno.test("Permissions: only organizers may invite, setActive, removeMember, deleteEvent", async () => {
  const [db, client] = await testDb();
  const ed = new EventDirectoryConcept(db);

  try {
    // Setup: Alice creates event (is Organizer). Invite Bob as DutyMember.
    const { event } = (await ed.createEvent({
      creator: alice,
      title: "Permissions Test",
      startsAt: new Date("2025-11-01T10:00:00Z"),
      endsAt:   new Date("2025-11-01T12:00:00Z"),
    })) as { event: ID };
    await ed.invite({ event, inviter: alice, invitee: bob, role: "DutyMember" });

    // Non-organizer tries to invite Cara
    const inviteByBob = await ed.invite({
      event, inviter: bob, invitee: cara, role: "DutyMember",
    });
    assertEquals("error" in inviteByBob, true, "Non-organizer inviting should fail");

    // Non-organizer tries to setActive
    const setByBob = await ed.setActive({ event, setter: bob, flag: false });
    assertEquals("error" in setByBob, true, "Non-organizer setActive should fail");

    // Non-organizer tries to remove member
    const removeByBob = await ed.removeMember({ event, actor: bob, member: alice });
    assertEquals("error" in removeByBob, true, "Non-organizer removeMember should fail");

    // Non-organizer tries to deleteEvent
    const deleteByBob = await ed.deleteEvent({ event, actor: bob });
    assertEquals("error" in deleteByBob, true, "Non-organizer deleteEvent should fail");

    // Organizer actions should work
    const inviteByAlice = await ed.invite({ event, inviter: alice, invitee: cara, role: "DutyMember" });
    assertEquals("error" in inviteByAlice, false, "Organizer invite should succeed");

    const setByAlice = await ed.setActive({ event, setter: alice, flag: false });
    assertEquals("error" in setByAlice, false, "Organizer setActive should succeed");

    const removeByAlice = await ed.removeMember({ event, actor: alice, member: cara });
    assertEquals("error" in removeByAlice, false, "Organizer removeMember should succeed");

  } finally {
    await client.close();
  }
});

Deno.test("Invite is idempotent on (event, user) and can update role", async () => {
  const [db, client] = await testDb();
  const ed = new EventDirectoryConcept(db);

  try {
    const { event } = (await ed.createEvent({
      creator: alice,
      title: "Idempotent Invite",
      startsAt: new Date("2025-12-01T10:00:00Z"),
      endsAt:   new Date("2025-12-01T12:00:00Z"),
    })) as { event: ID };

    // First invite as DutyMember
    const r1 = await ed.invite({ event, inviter: alice, invitee: bob, role: "DutyMember" });
    assertEquals("error" in r1, false);

    // Second invite — same user, update to Organizer
    const r2 = await ed.invite({ event, inviter: alice, invitee: bob, role: "Organizer" });
    assertEquals("error" in r2, false);

    const members = await ed._getEventMembers({ event });
    const bobRow = members.find(m => m.user === bob);
    assertExists(bobRow);
    assertEquals(bobRow!.role, "Organizer", "Role should have been updated to Organizer");
  } finally {
    await client.close();
  }
});

Deno.test("removeMember errors if user is not currently a member; deleteEvent removes memberships", async () => {
  const [db, client] = await testDb();
  const ed = new EventDirectoryConcept(db);

  try {
    const { event } = (await ed.createEvent({
      creator: alice,
      title: "Delete Cascade",
      startsAt: new Date("2026-01-05T09:00:00Z"),
      endsAt:   new Date("2026-01-05T10:00:00Z"),
    })) as { event: ID };

    // Removing a non-member should fail
    const rm1 = await ed.removeMember({ event, actor: alice, member: bob });
    assertEquals("error" in rm1, true, "Removing non-member should error");

    // Add then remove should succeed
    await ed.invite({ event, inviter: alice, invitee: bob, role: "DutyMember" });
    const rm2 = await ed.removeMember({ event, actor: alice, member: bob });
    assertEquals("error" in rm2, false, "Removing existing member should succeed");

    // Cascade delete: memberships should be gone after event deletion
    await ed.invite({ event, inviter: alice, invitee: bob, role: "DutyMember" });
    const del = await ed.deleteEvent({ event, actor: alice });
    assertEquals("error" in del, false, "Organizer deleteEvent should succeed");

    const evt = await ed._getEvent({ event });
    assertEquals(evt, null, "Event doc should be deleted");

    const members = await ed._getEventMembers({ event });
    assertEquals(members.length, 0, "All memberships should be deleted with the event");

  } finally {
    await client.close();
  }
});

```
